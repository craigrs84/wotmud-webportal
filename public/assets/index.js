(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function s(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(i){if(i.ep)return;i.ep=!0;const e=s(i);fetch(i.href,e)}})();class p{static FG_COLORS={30:"#000",31:"#ff5555",32:"#50fa7b",33:"#f1fa8c",34:"#bd93f9",35:"#ff79c6",36:"#8be9fd",37:"#f8f8f2",90:"#6272a4",91:"#ff6e6e",92:"#69ff94",93:"#ffffa5",94:"#d6acff",95:"#ff92df",96:"#a4ffff",97:"#ffffff"};static BG_COLORS={40:"#000",41:"#ff5555",42:"#50fa7b",43:"#f1fa8c",44:"#bd93f9",45:"#ff79c6",46:"#8be9fd",47:"#f8f8f2",100:"#6272a4",101:"#ff6e6e",102:"#69ff94",103:"#ffffa5",104:"#d6acff",105:"#ff92df",106:"#a4ffff",107:"#ffffff"};constructor(t,s=1e3){this.container=document.querySelector(t),this.maxLines=s,this.state={fg:null,bg:null,bold:!1,underline:!1},this.container.classList.add("console")}_parseAnsi(t){const s=/\x1b\[([0-9;]+)m/g,o=document.createDocumentFragment();let i=0;for(const e of t.matchAll(s))e.index>i&&o.appendChild(this._createSpan(t.slice(i,e.index))),e[1].split(";").forEach(a=>{a==="0"?this.state={fg:null,bg:null,bold:!1,underline:!1}:a==="1"?this.state.bold=!0:a==="4"?this.state.underline=!0:p.FG_COLORS[a]?this.state.fg=p.FG_COLORS[a]:p.BG_COLORS[a]?this.state.bg=p.BG_COLORS[a]:a==="39"?this.state.fg=null:a==="49"&&(this.state.bg=null)}),i=e.index+e[0].length;return i<t.length&&o.appendChild(this._createSpan(t.slice(i))),o}_createSpan(t){const s=document.createElement("span");return s.textContent=t,this.state.fg&&(s.style.color=this.state.fg),this.state.bg&&(s.style.backgroundColor=this.state.bg),this.state.bold&&(s.style.fontWeight="bold"),this.state.underline&&(s.style.textDecoration="underline"),s}write(t=""){for(t.toString().split(`
`).forEach((o,i)=>{let e=this.container.lastElementChild;(!e||i>0)&&(e=document.createElement("div"),this.container.appendChild(e)),o.length>0&&e.appendChild(this._parseAnsi(o))});this.container.children.length>this.maxLines;)this.container.removeChild(this.container.firstChild);this.scrollToBottom()}writeln(t=""){this.write(t+`
`)}clear(){this.container.innerHTML=""}scrollToBottom(){this.container.scrollTop=this.container.scrollHeight}}class k{constructor(t){this.url=t,this.socket=null,this.buffer="",this.timeout=null,this.callbacks=[],this.regex=/\r\n|\n\r|\r\x00|\r|\n|\x00/g}connect(){this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this._emit({type:"system",data:"Connected successfully."})},this.socket.onclose=()=>{this._emit({type:"system",data:"Disconnected."})},this.socket.onerror=t=>{this._emit({type:"system",data:"Socket Error."})},this.socket.onmessage=t=>this._handleMessage(t)}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"cmd",data:t}))}onMessage(t){this.callbacks.push(t)}_emit(t){this.callbacks.forEach(s=>s(t))}_handleMessage(t){clearTimeout(this.timeout),this.timeout=null;const s=JSON.parse(t.data);this.buffer+=s.data,console.log(s);let o=0;const e=[...this.buffer.matchAll(this.regex)].map(n=>{const a=this.buffer.substring(o,n.index),h=n[0],c={text:a,delimiter:h};return o=n.index+h.length,c}).filter(n=>n.text.trim()||n.delimiter.includes(`
`));if(this.buffer=this.buffer.substring(o),this.buffer==="By what name do you wish to be known? "||this.buffer==="Passphrase: "||this.buffer.endsWith("> ")||[" ","-","=","+","*"].includes(this.buffer)){const n=this.buffer;this.buffer="",e.push({text:n,delimiter:""})}for(let n of e)this._emit({data:n.text,delimiter:n.delimiter,prompt:n.text.endsWith("> "),timer:[" ","-","=","+","*"].includes(n.text)});!this.timeout&&this.buffer.length&&(this.timeout=setTimeout(()=>{console.log("flushing after delay",this.buffer),this.timeout=null;const n=this.buffer;this.buffer="",this._emit({data:n,delimiter:"",prompt:!1,timer:!1})},250))}}const v={20:{id:20,name:"inside",color:"#FFFFFF"},21:{id:21,name:"wilderness",color:"#228B22"},22:{id:22,name:"road",color:"#A52A2A"},23:{id:23,name:"horse",color:"#DEB887"},24:{id:24,name:"swamp",color:"#9400D3"},25:{id:25,name:"water",color:"#0000FF"},26:{id:26,name:"drink",color:"#66CDAA"},27:{id:27,name:"weaponsmith",color:"#4682B4"},28:{id:28,name:"armorer",color:"#808080"},29:{id:29,name:"blacksmith",color:"#FF8C00"},30:{id:30,name:"bank",color:"#FFD700"},31:{id:31,name:"stables",color:"#800080"},32:{id:32,name:"rent",color:"#008000"},33:{id:33,name:"grocer",color:"#FF0000"},34:{id:34,name:"warrior",color:"#A0522D"},35:{id:35,name:"rogue",color:"#2F4F4F"},36:{id:36,name:"hunter",color:"#9ACD32"},37:{id:37,name:"pk",color:"#D3D3D3"},38:{id:38,name:"city",color:"#A52A2A"},39:{id:39,name:"herb",color:"#FFFF00"},40:{id:40,name:"tailor",color:"#FF00FF"},41:{id:41,name:"nochannel",color:"#808080"},42:{id:42,name:"portalstone",color:"#808080"},43:{id:43,name:"trees",color:"#7CFC00"},44:{id:44,name:"smob",color:"#B22222"},45:{id:45,name:"herbalist",color:"#FFFF00"}};function g(f){return f?.replace(/\s+/g," ").trim().toLowerCase()??""}function b(f){let t=0xcbf29ce484222325n;const s=0x100000001b3n;for(let o=0;o<f.length;o++)t^=BigInt(f.charCodeAt(o)),t=t*s&0xffffffffffffffffn;return t}class F{constructor(t){if(this.canvas=document.querySelector(t),!this.canvas)throw new Error(`Canvas element with selector "${t}" not found.`);this.ctx=this.canvas.getContext("2d"),this.baseScale=10,this.tileSize=1,this.scaledTileSize=this.tileSize*this.baseScale,this.mapData=null,setTimeout(()=>{this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight},0);let s;window.addEventListener("resize",()=>{clearTimeout(s),s=setTimeout(()=>{this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.mapData&&this.lastRenderArgs&&this.render(...this.lastRenderArgs)},50)})}async init(t="map.json"){const o=await(await fetch(t)).json();o.areasById={},o.roomsById={};const i=[];o.areas.forEach(e=>{o.areasById[e.id]=e,e.rooms=e.rooms??[],e.labels=e.labels??[],e.levelsById={},e.rooms.forEach(n=>{o.roomsById[n.id]=n,n.areaId=e.id,n.coordinates[1]*=-1;const a=n.coordinates[2];e.levelsById[a]||(e.levelsById[a]={id:a,rooms:[]}),e.levelsById[a].rooms.push(n)}),e.labels.forEach(n=>{n.areaId=e.id,n.coordinates[1]*=-1;const a=n.image.join("");if(a){n.htmlImage=new Image;const h=new Promise(c=>{n.htmlImage.onload=c,n.htmlImage.src="data:image/png;base64,"+a});i.push(h)}})}),await Promise.all(i),this.mapData=o,this.roomMap=new Map;for(let e of this.mapData.areas.flatMap(n=>n.rooms)){const n=g(e.name),a=g(e.userData?.description);if(!n||!a)return;const h=b(`${g(e.name)}|${g(e.userData?.description)}`);let c=this.roomMap.get(h);c||(c=[],this.roomMap.set(h,c)),c.push(e)}}render(t,s,o,i=10){if(!this.mapData)return;this.lastRenderArgs=[t,s,o,i];const e=this.mapData.areasById[t],n=e.levelsById[s];if(!n)return;const a=n.rooms,h={},c=this.mapData.roomsById[o]||a[0],x=c.coordinates[0],w=c.coordinates[1];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.canvas.width/2-x*i,this.canvas.height/2-w*i),this.ctx.scale(i/this.baseScale,i/this.baseScale),a.forEach(r=>{const m=r.coordinates[0]*this.baseScale,u=r.coordinates[1]*this.baseScale;r.exits.forEach(d=>{const l=this.mapData.roomsById[d.exitId];if(!(!l||d.name==="up"||d.name==="down"))if(l.areaId===t){const y=r.id<l.id?`${r.id}|${l.id}`:`${l.id}|${r.id}`;h[y]||(this.ctx.beginPath(),this.ctx.strokeStyle="#cccccc",l.exits.some(S=>S.exitId===r.id)||this.ctx.setLineDash([2,3]),this.ctx.moveTo(m,u),this.ctx.lineTo(l.coordinates[0]*this.baseScale,l.coordinates[1]*this.baseScale),this.ctx.stroke(),this.ctx.setLineDash([]),h[y]=!0)}else this._drawAreaStub(m,u,d.name)})}),a.forEach(r=>{const m=r.coordinates[0]*this.baseScale,u=r.coordinates[1]*this.baseScale,d=v[r.environment]||{color:"#cc0000"};this.ctx.beginPath(),this.ctx.rect(m-this.scaledTileSize/2,u-this.scaledTileSize/2,this.scaledTileSize,this.scaledTileSize),this.ctx.strokeStyle="#cccccc",this.ctx.fillStyle=d.color,this.ctx.fill(),this.ctx.stroke(),r.id===o&&this._drawSelectionHighlight(m,u)}),e.labels.filter(r=>r.coordinates[2]===s).forEach(r=>{const m=r.coordinates[0]*this.baseScale,u=r.coordinates[1]*this.baseScale,d=r.size[0]*this.baseScale*.9,l=r.size[1]*this.baseScale*.9;r.htmlImage&&this.ctx.drawImage(r.htmlImage,m,u,d,l)}),this.ctx.restore()}_drawAreaStub(t,s,o){this.ctx.beginPath(),this.ctx.strokeStyle="#ff0000";const i=this.baseScale*1.5;this.ctx.moveTo(t,s),o==="west"&&this.ctx.lineTo(t-i,s),o==="east"&&this.ctx.lineTo(t+i,s),o==="north"&&this.ctx.lineTo(t,s-i),o==="south"&&this.ctx.lineTo(t,s+i),this.ctx.stroke()}_drawSelectionHighlight(t,s){this.ctx.beginPath(),this.ctx.arc(t,s,this.scaledTileSize,0,Math.PI*2),this.ctx.strokeStyle="#ff0000",this.ctx.fillStyle="#cc000077",this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(t,s,this.scaledTileSize*1.25,0,Math.PI*2),this.ctx.strokeStyle="#ff0000",this.ctx.stroke()}}class I{constructor(){this.terminal=new p("#terminal",5e3),this.comms=new p("#comms",1e3),this.socket=new k("ws://localhost:8080"),this.map=new F("#map"),this.map.init(),this.trailing=!1,this.history=[],this.historyIndex=-1,this.inputEl=document.getElementById("cmd-input"),this.connectButton=document.getElementById("connect-button"),this.socket.onMessage(t=>this.onSocketMessage(t)),this.connectButton.onclick=()=>this.socket.connect(),this.inputEl.onkeydown=t=>this._handleInput(t)}onSocketMessage(t){const s=t.type||"raw";this._handleTriggers(t.data),this.trailing&&!t.timer&&(this.terminal.writeln(),this.trailing=!1),s==="system"?this.terminal.writeln(t.data):s==="raw"&&(t.timer?(this.terminal.write(t.data),this.trailing=!0):this.terminal.writeln(t.data))}_handleInput(t){t.key==="Enter"?this._submitCommand():t.key==="ArrowUp"?this._navigateHistory(-1):t.key==="ArrowDown"&&this._navigateHistory(1)}_submitCommand(){const t=this.inputEl.value.trim();if(!t)return;this.trailing&&(this.terminal.writeln(),this.trailing=!1),this.terminal.writeln(`\x1B[90m${t}\x1B[0m`),t.split(";").forEach(o=>this.socket.send(o.trim())),this.history[this.history.length-1]!==t&&this.history.push(t),this.history.length>50&&this.history.shift(),this.historyIndex=this.history.length-1,this.inputEl.select()}_navigateHistory(t){t!==0&&(this.historyIndex=Math.max(-1,Math.min(this.historyIndex+t,this.history.length)),this.inputEl.value=this.history[this.historyIndex]||"",setTimeout(()=>this.inputEl.select(),0))}_handleTriggers(t){(t.includes(" says ")||t.includes(" tells you ")||t.includes("You tell ")||t.includes("You say ")||t.includes("whispers")||t.includes("shouts")||t.includes("yells")||t.includes(" chats ")||t.includes(" narrates "))&&this.comms.writeln(t);const s=t.match(/^\x1B\[36m(.+)\x1B\[0m$/);if(s)this.isRoom=!0,this.roomName=s[1],this.roomDesc="";else if(this.isRoom&&t.includes("obvious exits:")){this.isRoom=!1;const o=b(`${g(this.roomName)}|${g(this.roomDesc)}`),i=this.map.roomMap.get(o);if(i){const e=i[0];console.log("Room detected:",e),this.map.render(e.areaId,e.coordinates[2],e.id)}}else this.isRoom&&(this.roomDesc+=t+`
`)}}new I;
